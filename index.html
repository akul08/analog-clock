<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>d3 O'clock</title>
    <script src="//d3js.org/d3.v3.min.js"></script>
    <style>
        .timeText {
            font-size: 26px;
        }

        .innercircle {
            fill: #fff;
            stroke: #000;
            stroke-width: 3;
        }
        .clockhand {
            stroke-linecap: round;
        }
        .textTicks text {
            font-size: 2px;
        }
    </style>
</head>

<body>
    <div class="chart"></div>
    <script>
        console.log(Date());
        var fields;
        fields = function() {
            var currentTime, hour, minute, second;
            currentTime = new Date();
            second = currentTime.getSeconds();
            minute = currentTime.getMinutes() + second / 60;
            hour = currentTime.getHours() + minute / 60;
            return data = [{
                "unit": "seconds",
                "numeric": second
            }, {
                "unit": "minutes",
                "numeric": minute
            }, {
                "unit": "hours",
                "numeric": hour
            }];
        }

        var width, height, offSetX, offSetY, pi, scaleSecs, scaleMins, scaleHours;
        width = 1400;
        height = 800;
        offSetX = 950;
        offSetY = 500;

        pi = Math.PI;
        scaleSecs = d3.scale.linear().domain([0, 59 + 999 / 1000]).range([0, 2 * pi]);
        scaleMins = d3.scale.linear().domain([0, 59 + 59 / 60]).range([0, 2 * pi]);
        scaleHours = d3.scale.linear().domain([0, 11 + 59 / 60]).range([0, 2 * pi]);

        tickDomain = d3.scale.linear().domain([0, 11 + 59/60]).range([0, 2*pi]);
        tickDomainInner = d3.scale.linear().domain([0, 59 + 59/60]).range([0, 2*pi]);
        var vis, clockGroup, textGroup;

        vis = d3.selectAll(".chart")
            .append("svg:svg")
            .attr("width", width)
            .attr("height", height);

        clockGroup = vis.append("svg:g")
            .attr("transform", "translate(" + offSetX + "," + offSetY + ")");

        textGroup = vis.append('svg:g')
            .attr("transform", "translate(" + (offSetX) + "," + (offSetY+200) + ")");

        clockGroup.append("svg:circle")
            .attr("r", 120).attr("fill", "none")
            .attr("class", "clock outercircle")
            .attr("stroke", "black")
            .attr("stroke-width", 2);

        clockGroup.append("svg:circle")
            .attr("r", 6).attr("fill", "black")
            .attr("class", "clock innercircle")

        var ticks = d3.svg.arc()
            .innerRadius(105)
            .outerRadius(120)
            .startAngle(function(d) {
                return tickDomain(d);
            })
            .endAngle(function(d) {
                return tickDomain(d);
            });

        var ticksInner = d3.svg.arc()
            .innerRadius(115)
            .outerRadius(120)
            .startAngle(function(d) {
                return tickDomainInner(d);
            })
            .endAngle(function(d) {
                return tickDomainInner(d);
            });

        clockGroup.selectAll('.ticks')
            .data([0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11])
            .enter()
            .append("svg:path")
            .attr("d", function (d){
                return ticks(d);
            })
            .attr('class', 'ticks')
            .attr('stroke', 'black')
            .attr('fill', 'none');

        innerTicksData = [];
        for (var i = 0; i <= 59; i++) {
            innerTicksData.push(i);
        }
        clockGroup.selectAll('.ticksInner')
            .data(innerTicksData)
            .enter()
            .append("svg:path")
            .attr("d", function (d){
                return ticksInner(d);
            })
            .attr('class', 'ticksInner')
            .attr('stroke', 'grey')
            .attr('fill', 'none');

        clockGroup.selectAll('.textTicks')
            .data([12, 6, 3, 9])
            .enter()
            .append('svg:text')
            .text(function (d, i) {
                return d;
            })
            .attr('class', function (d, i) {
                return 'time_' + d;
            })
            .attr("text-anchor", "middle")
            .attr('dy', function (d, i) {
                if (i===0) {
                    return '-11%';
                }
                else if (i === 1 || i === 2) {
                    return 5;
                } else {
                    return '13%';
                }
            })
            .attr('dx', function (d, i) {
                if (i === 0 || i === 3) {
                    return 0;
                }
                else if (i === 1) {
                    return '-7%';
                } else {
                    return '7%';
                }
            });


        var render;
        render = function(data) {
            var hourArc, minuteArc, secondArc;

            clockGroup.selectAll(".clockhand").remove();

            secondArc = d3.svg.arc()
                .innerRadius(6)
                .outerRadius(104)
                .startAngle(function(d) {
                    return scaleSecs(d.numeric);
                })
                .endAngle(function(d) {
                    return scaleSecs(d.numeric);
                });
            minuteArc = d3.svg.arc()
                .innerRadius(6)
                .outerRadius(100)
                .startAngle(function(d) {
                    return scaleMins(d.numeric);
                })
                .endAngle(function(d) {
                    return scaleMins(d.numeric);
                });

            hourArc = d3.svg.arc()
                .innerRadius(6)
                .outerRadius(70)
                .startAngle(function(d) {
                    return scaleHours(d.numeric % 12);
                })
                .endAngle(function(d) {
                    return scaleHours(d.numeric % 12);
                });

            clockGroup.selectAll(".clockhand")
                .data(data)
                .enter()
                .append("svg:path")
                .attr("d", function(d) {
                    if (d.unit === "seconds") {
                        return secondArc(d);
                    } else if (d.unit === "minutes") {
                        return minuteArc(d);
                    } else if (d.unit === "hours") {
                        return hourArc(d);
                    }
                })
                .attr("class", "clockhand")
                .attr("stroke", "black")
                .attr("stroke-width", function(d) {
                    if (d.unit === "seconds") {
                        return 1;
                    } else if (d.unit === "minutes") {
                        return 4;
                    } else if (d.unit === "hours") {
                        return 5;
                    }
                })
                .attr("fill", "none");
            var timeText = function(d){
                time = Math.floor(d[2].numeric) + ':' +
                    Math.floor(d[1].numeric) + ':' +
                    Math.round(d[0].numeric);
                return time;
            }

            console.log(timeText(data));
            textGroup.selectAll('text')
                .remove();
            textGroup.selectAll('text')
                .data(data)
                .enter()
                .append("text")
                .attr('class', 'timeText')
                .text(
                function (d) {
                    return timeText(data);
                })
                .attr("text-anchor", "middle");
        };

        setInterval ( function() {
            var data;
            data = fields();
            return render(data);
        }, 1000);
    </script>
</body>

</html>
